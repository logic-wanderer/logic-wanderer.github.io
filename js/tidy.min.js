(function(l,h){typeof exports=="object"&&typeof module!="undefined"?h(exports,require("d3-array")):typeof define=="function"&&define.amd?define(["exports","d3-array"],h):(l=typeof globalThis!="undefined"?globalThis:l||self,h(l.Tidy={},l.d3))})(this,function(l,h){"use strict";function z(n,...t){if(typeof n=="function")throw new Error("You must supply the data as the first argument to tidy()");let e=n;for(const o of t)e=o(e);return e}function rn(n){return e=>e.filter(n)}function cn(n,t){return o=>{if(typeof n=="function"){if(!n(o))return o}else if(!n)return o;return z(o,...t)}}function sn(n){return e=>e.map(n)}function S(n){return n==null?[]:Array.isArray(n)?n:[n]}function ln(n){return e=>{if(n=S(n),!n.length){const u=new Set;for(const s of e)u.add(s);return Array.from(u)}const o=new Map,r=[],c=n[n.length-1];for(const u of e){let s=o,f=!1;for(const a of n){const d=typeof a=="function"?a(u):u[a];if(a===c){f=s.has(d),f||(r.push(u),s.set(d,!0));break}s.has(d)||s.set(d,new Map),s=s.get(d)}}return r}}function I(n){return e=>{const o=S(n).map(r=>typeof r=="function"?r:V(r));return e.slice().sort((r,c)=>{for(const u of o){const s=u(r,c);if(s!==0)return s}return 0})}}function V(n){return function(e,o){return h.ascending(e[n],o[n])}}function U(n){return function(e,o){return h.descending(e[n],o[n])}}function fn(n,t,e){let{position:o="start"}=e!=null?e:{};const r=o==="end"?-1:1,c=new Map;for(let s=0;s<t.length;++s)c.set(t[s],s);const u=typeof n=="function"?n:s=>s[n];return function(f,a){var d,i;const m=(d=c.get(u(f)))!=null?d:-1,y=(i=c.get(u(a)))!=null?i:-1;return m>=0&&y>=0?m-y:m>=0?r*-1:y>=0?r*1:0}}function D(n,t){return o=>{t=t!=null?t:{};const r={},c=Object.keys(n);for(const u of c)r[u]=n[u](o);if(t.rest&&o.length){const u=Object.keys(o[0]);for(const s of u)c.includes(s)||(r[s]=t.rest(s)(o))}return[r]}}function R(n,t,e,o){if(!n.length)return[];const r={};let c;if(o==null)c=Object.keys(n[0]);else{c=[];for(const u of S(o))typeof u=="function"?c.push(...u(n)):c.push(u)}for(const u of c){if(e){const s=n.map(f=>f[u]);if(!e(s))continue}r[u]=t(u)(n)}return[r]}function B(n){return e=>R(e,n)}function N(n,t){return o=>R(o,t,n)}function J(n,t){return o=>R(o,t,void 0,n)}function w(n){return e=>{const o=[];for(const r of e){const c={...r};for(const u in n){const s=n[u],f=typeof s=="function"?s(c):s;c[u]=f}o.push(c)}return o}}function an(n,t){return o=>{const r=D(n)(o),c=w(t)(r);return[...o,...c]}}function mn(n,t){return o=>{const r=B(n)(o),c=w(t)(r);return[...o,...c]}}function dn(n,t,e){return r=>{const c=N(n,t)(r),u=w(e)(c);return[...r,...u]}}function yn(n,t,e){return r=>{const c=J(n,t)(r),u=w(e)(c);return[...r,...u]}}function $(n,t){return{...n,...t.reduce((e,o)=>(e[o[0]]=o[1],e),{})}}function L(n,t,e,o,r,c=0){for(const[u,s]of n.entries()){const f=[...e,u];if(s instanceof Map){const a=o(t,f,c);L(s,a,f,o,r,c+1)}else r(t,f,s,c)}return t}function pn(n,t,e=o=>o[o.length-1]){function o(u,s){const f=new Map;return u.set(e(s),f),f}function r(u,s,f){u.set(e(s),t(f,s))}const c=new Map;return L(n,c,[],o,r),c}const O=n=>n;function _(n,t,e){return r=>{const c=gn(r,n),u=hn(c,t,e==null?void 0:e.addGroupKeys);if(e==null?void 0:e.export)switch(e.export){case"grouped":return u;case"entries":return k(u,{...e,export:"levels",levels:["entries"]});case"entries-object":case"entries-obj":case"entriesObject":return k(u,{...e,export:"levels",levels:["entries-object"]});case"object":return k(u,{...e,export:"levels",levels:["object"]});case"map":return k(u,{...e,export:"levels",levels:["map"]});case"keys":return k(u,{...e,export:"levels",levels:["keys"]});case"values":return k(u,{...e,export:"levels",levels:["values"]});case"levels":return k(u,e)}return vn(u,e==null?void 0:e.addGroupKeys)}}_.grouped=n=>({...n,export:"grouped"}),_.entries=n=>({...n,export:"entries"}),_.entriesObject=n=>({...n,export:"entries-object"}),_.object=n=>({...n,export:"object"}),_.map=n=>({...n,export:"map"}),_.keys=n=>({...n,export:"keys"}),_.values=n=>({...n,export:"values"}),_.levels=n=>({...n,export:"levels"});function hn(n,t,e){let o=n;if(!(t==null?void 0:t.length))return o;for(const r of t)o=pn(o,(c,u)=>{let f=r(c,{groupKeys:u});return e!==!1&&(f=f.map(a=>$(a,u))),f});return o}function gn(n,t){const e=S(t).map((r,c)=>{let u;typeof r=="function"?u=r.name?r.name:`group_${c}`:u=r.toString();const s=typeof r=="function"?r:a=>a[r],f=new Map;return a=>{const d=s(a);if(f.has(d))return f.get(d);const i=[u,d];return f.set(d,i),i}});return h.group(n,...e)}function vn(n,t){const e=[];return L(n,e,[],O,(o,r,c)=>{let u=c;t!==!1&&(u=c.map(s=>$(s,r))),o.push(...u)}),e}const _n=n=>n.join("/");function bn(n){var t;const{flat:e,single:o,mapLeaf:r=O,mapLeaves:c=O}=n;let u;return n.flat&&(u=(t=n.compositeKey)!=null?t:_n),{groupFn:(a,d)=>o?r($(a[0],d)):c(a.map(i=>r($(i,d)))),keyFn:e?a=>u(a.map(d=>d[1])):a=>a[a.length-1][1]}}function k(n,t){const{groupFn:e,keyFn:o}=bn(t);let{mapEntry:r=O}=t;const{levels:c=["entries"]}=t,u=[];for(const d of c)switch(d){case"entries":case"entries-object":case"entries-obj":case"entriesObject":{const i=d==="entries-object"||d==="entries-obj"||d==="entriesObject"?([m,y])=>({key:m,values:y}):r;u.push({id:"entries",createEmptySubgroup:()=>[],addSubgroup:(m,y,g,b)=>{m.push(i([g,y],b))},addLeaf:(m,y,g,b)=>{m.push(i([y,g],b))}});break}case"map":u.push({id:"map",createEmptySubgroup:()=>new Map,addSubgroup:(i,m,y)=>{i.set(y,m)},addLeaf:(i,m,y)=>{i.set(m,y)}});break;case"object":u.push({id:"object",createEmptySubgroup:()=>({}),addSubgroup:(i,m,y)=>{i[y]=m},addLeaf:(i,m,y)=>{i[m]=y}});break;case"keys":u.push({id:"keys",createEmptySubgroup:()=>[],addSubgroup:(i,m,y)=>{i.push([y,m])},addLeaf:(i,m)=>{i.push(m)}});break;case"values":u.push({id:"values",createEmptySubgroup:()=>[],addSubgroup:(i,m)=>{i.push(m)},addLeaf:(i,m,y)=>{i.push(y)}});break;default:typeof d=="object"&&u.push(d)}const s=(d,i,m)=>{var y,g;if(t.flat)return d;const b=(y=u[m])!=null?y:u[u.length-1],A=((g=u[m+1])!=null?g:b).createEmptySubgroup();return b.addSubgroup(d,A,o(i),m),A},f=(d,i,m,y)=>{var g;((g=u[y])!=null?g:u[u.length-1]).addLeaf(d,o(i),e(m,i),y)},a=u[0].createEmptySubgroup();return L(n,a,[],s,f)}function H(){return n=>n.length}function P(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.fsum(e,t)}function G(n){return e=>{const{name:o="n",wt:r}=n!=null?n:{};return D({[o]:r==null?H():P(r)})(e)}}function Sn(n,t){return o=>{t=t!=null?t:{};const{name:r="n",sort:c}=t;return z(o,_(n,[G(t)]),c?I(U(r)):O)}}function jn(n){return e=>e.map(o=>{var r;const c={},u=Object.keys(o);for(const s of u){const f=(r=n[s])!=null?r:s;c[f]=o[s]}return c})}function W(n,t){return o=>o.slice(n,t)}const kn=n=>W(0,n),wn=n=>W(-n);function Mn(n,t){return o=>I(t)(o).slice(0,n)}function Kn(n,t){return o=>I(t)(o).slice(-n).reverse()}function Fn(n,t){t=t!=null?t:{};const{replace:e}=t;return r=>{if(!r.length)return r.slice();if(e){const c=[];for(let u=0;u<n;++u)c.push(r[Math.floor(Math.random()*r.length)]);return c}return h.shuffle(r.slice()).slice(0,n)}}function Y(n,t){if(n.length===0||t.length===0)return{};const e=Object.keys(n[0]),o=Object.keys(t[0]),r={};for(const c of e)o.includes(c)&&(r[c]=c);return r}function Z(n){if(Array.isArray(n)){const t={};for(const e of n)t[e]=e;return t}else if(typeof n=="object")return n;return{[n]:n}}function Q(n,t,e){for(const o in e){const r=e[o];if(n[r]!==t[o])return!1}return!0}function In(n,t){return o=>{const r=(t==null?void 0:t.by)==null?Y(o,n):Z(t.by);return o.flatMap(u=>n.filter(f=>Q(u,f,r)).map(f=>({...u,...f})))}}function X(n,t){return o=>{const r=(t==null?void 0:t.by)==null?Y(o,n):Z(t.by);return o.flatMap(u=>{const s=n.filter(f=>Q(u,f,r));return s.length?s.map(f=>({...u,...f})):u})}}function On(n){return e=>{const o=e.map(r=>({...r}));for(const r in n){const c=n[r],u=typeof c=="function"?c(o):c,s=(u==null?void 0:u[Symbol.iterator])&&typeof u!="string"?u:e.map(()=>u);let f=-1;for(const a of o)a[r]=s[++f]}return o}}function M(n){return n.length<1?[]:Object.keys(n[0])}function x(){return n=>M(n)}function nn(n,t){let e=[];for(const c of S(t))typeof c=="function"?e.push(...c(n)):e.push(c);e.length&&e[0][0]==="-"&&(e=[...x()(n),...e]);const o={},r=[];for(let c=e.length-1;c>=0;c--){const u=e[c];if(u[0]==="-"){o[u.substring(1)]=!0;continue}if(o[u]){o[u]=!1;continue}r.unshift(u)}return e=Array.from(new Set(r)),e}function E(n){return e=>{let o=nn(e,n);return o.length?e.map(r=>{const c={};for(const u of o)c[u]=r[u];return c}):e}}function An(n){return e=>{const o=w(n)(e);return E(Object.keys(n))(o)}}function en(n){return e=>typeof n=="function"?[...e,...S(n(e))]:[...e,...S(n)]}function zn(n){return e=>{const{namesFrom:o,valuesFrom:r,valuesFill:c,valuesFillMap:u,namesSep:s="_"}=n,f=Array.isArray(o)?o:[o],a=Array.isArray(r)?r:[r],d=[];if(!e.length)return d;const i=Object.keys(e[0]).filter(p=>!f.includes(p)&&!a.includes(p)),m={};for(const p of e)for(const v of f)m[v]==null&&(m[v]={}),m[v][p[v]]=!0;const y=[];for(const p in m)y.push(Object.keys(m[p]));const g={},b=$n(s,y);for(const p of b){if(a.length===1){g[p]=u!=null?u[a[0]]:c;continue}for(const v of a)g[`${v}${s}${p}`]=u!=null?u[v]:c}function K(p){if(!p.length)return[];const v={...g};for(const j of i)v[j]=p[0][j];for(const j of p){const q=f.map(F=>j[F]).join(s);if(a.length===1){v[q]=j[a[0]];continue}for(const F of a)v[`${F}${s}${q}`]=j[F]}return[v]}return i.length?z(e,_(i,[K])):K(e)}}function $n(n="_",t){function e(r,c,u){if(!u.length&&c!=null){r.push(c);return}const s=u[0],f=u.slice(1);for(const a of s)e(r,c==null?a:`${c}${n}${a}`,f)}const o=[];return e(o,null,t),o}function Ln(n){return e=>{var o;const{namesTo:r,valuesTo:c,namesSep:u="_"}=n,s=(o=n.cols)!=null?o:[],f=nn(e,s),a=Array.isArray(r)?r:[r],d=Array.isArray(c)?c:[c],i=a.length>1,m=d.length>1,y=[];for(const g of e){const b=Object.keys(g).filter(p=>!f.includes(p)),K={};for(const p of b)K[p]=g[p];const A=m?Array.from(new Set(f.map(p=>p.substring(p.indexOf(u)+1)))):f;for(const p of A){const v={...K};for(const j of d){const q=m?`${j}${u}${p}`:p,F=i?p.split(u):[p];let fe=0;for(const ae of a){const ie=F[fe++];v[ae]=ie,v[j]=g[q]}}y.push(v)}}return y}}function tn(n){return e=>{const o=qn(n),r=[];for(const c in o){const u=o[c];let s;typeof u=="function"?s=u(e):Array.isArray(u)?s=u:s=Array.from(new Set(e.map(f=>f[c]))),r.push(s.map(f=>({[c]:f})))}return Tn(r)}}function Tn(n){function t(o,r,c){if(!c.length&&r!=null){o.push(r);return}const u=c[0],s=c.slice(1);for(const f of u)t(o,{...r,...f},s)}const e=[];return t(e,null,n),e}function qn(n){if(Array.isArray(n)){const t={};for(const e of n)t[e]=e;return t}else if(typeof n=="object")return n;return{[n]:n}}function un(n,t=1){let[e,o]=h.extent(n);const r=[];let c=e;for(;c<=o;)r.push(c),c+=t;return r}function C(n,t="day",e=1){let[o,r]=h.extent(n);const c=[];let u=new Date(o);for(;u<=r;)if(c.push(new Date(u)),t==="day"||t==="d"||t==="days")u.setUTCDate(u.getUTCDate()+1*e);else if(t==="week"||t==="w"||t==="weeks")u.setUTCDate(u.getUTCDate()+7*e);else if(t==="month"||t==="m"||t==="months")u.setUTCMonth(u.getUTCMonth()+1*e);else if(t==="year"||t==="y"||t==="years")u.setUTCFullYear(u.getUTCFullYear()+1*e);else throw new Error("Invalid granularity for date sequence: "+t);return c}function Dn(n,t){return function(o){t=t!=null?t:1;const r=typeof n=="function"?n:c=>c[n];return un(o.map(r),t)}}function Rn(n,t,e){return function(r){t=t!=null?t:"day",e=e!=null?e:1;const c=typeof n=="function"?n:u=>u[n];return C(r.map(c),t,e)}}function Wn(n,t,e){return function(r){t=t!=null?t:"day",e=e!=null?e:1;const c=typeof n=="function"?n:u=>u[n];return C(r.map(u=>new Date(c(u))),t,e).map(u=>u.toISOString())}}function on(n){return e=>{const o=[];for(const r of e){const c={...r};for(const u in n)c[u]==null&&(c[u]=n[u]);o.push(c)}return o}}function En(n,t){return o=>{const r=tn(n)(o),c=X(o)(r);return t?on(t)(c):c}}function Cn(n){return e=>{const o=S(n),r={};return e.map(c=>{const u={...c};for(const s of o)u[s]!=null?r[s]=u[s]:r[s]!=null&&(u[s]=r[s]);return u})}}function Vn(n,t){return(o,r)=>{var c;let u="[tidy.debug";if((c=r==null?void 0:r.groupKeys)==null?void 0:c.length){const y=r.groupKeys.map(g=>g.join(": ")).join(", ");y.length&&(u+="|"+y)}t=t!=null?t:{};const{limit:s=10,output:f="table"}=t,a="--------------------------------------------------------------------------------";let d=a.length;const i=u+"]"+(n==null?"":" "+n);return d=Math.max(0,d-(i.length+2)),console.log(`${i} ${a.substring(0,d)}`),console[f](s==null||s>=o.length?o:o.slice(0,s)),o}}function T(n,t,e){return n==null||t==null?void 0:t===0&&n===0?0:!e&&t===0?void 0:n/t}var Un=Object.freeze({__proto__:null,rate:T});function Bn(n,t,e){const o=typeof n=="function"?n:s=>s[n],r=typeof t=="function"?t:s=>s[t],{predicate:c,allowDivideByZero:u}=e!=null?e:{};return c==null?s=>{const f=r(s),a=o(s);return T(a,f,u)}:s=>{if(!c(s))return;const f=r(s),a=o(s);return T(a,f,u)}}function Nn(n,t){let e=new h.Adder,o=0;return Float64Array.from(n,r=>e.add(+(t(r,o++,n)||0)))}function Jn(n,t){let e=0;for(let o=0;o<n.length;++o){const r=t(n[o],o,n);+r===r&&(e+=1)}return e?h.fsum(n,t)/e:void 0}function Hn(n){const t=typeof n=="function"?n:e=>e[n];return e=>Nn(e,t)}function Pn(n,t,e){const{partial:o=!1}=e!=null?e:{};return r=>r.map((c,u)=>{const s=u;if(!o&&s-n+1<0)return;const f=Math.max(0,s-n+1),a=r.slice(f,s+1);return t(a,s)})}function Gn(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.min(e,t)}function Yn(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.max(e,t)}function Zn(n){const t=typeof n=="function"?n:e=>e[n];return e=>Jn(e,t)}function Qn(n,t){const e=typeof n=="function"?n:r=>r[n],o=typeof t=="function"?t:r=>r[t];return r=>{const c=h.fsum(r,e),u=h.fsum(r,o);return T(c,u)}}function Xn(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.median(e,t)}function xn(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.deviation(e,t)}function ne(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.variance(e,t)}function ee(n){const t=typeof n=="function"?n:e=>e[n];return e=>e.length?t(e[0]):void 0}function te(n){const t=typeof n=="function"?n:e=>e[n];return e=>e.length?t(e[e.length-1]):void 0}function ue(n,t=!0){return e=>{const o=new RegExp(`^${n}`,t?"i":void 0);return M(e).filter(c=>o.test(c))}}function oe(n,t=!0){return e=>{const o=new RegExp(`${n}$`,t?"i":void 0);return M(e).filter(c=>o.test(c))}}function re(n,t=!0){return e=>{const o=new RegExp(n,t?"i":void 0);return M(e).filter(c=>o.test(c))}}function ce(n){return t=>M(t).filter(o=>n.test(o))}function se(n,t,e){return o=>{const r=M(o),c=[];for(let u=t[0];u<=t[1];++u){const s=e==null?u:new String("00000000"+u).slice(-e);c.push(`${n}${s}`)}return r.filter(u=>c.includes(u))}}function le(n){return t=>{let e=new Set;for(const r of S(n))if(typeof r=="function"){const c=r(t);for(const u of c)e.add(u)}else e.add(r);return Array.from(e).map(r=>`-${r}`)}}l.TMath=Un,l.addItems=en,l.addRows=en,l.arrange=I,l.asc=V,l.complete=En,l.contains=re,l.count=Sn,l.cumsum=Hn,l.debug=Vn,l.desc=U,l.deviation=xn,l.distinct=ln,l.endsWith=oe,l.everything=x,l.expand=tn,l.fill=Cn,l.filter=rn,l.first=ee,l.fixedOrder=fn,l.fullSeq=Dn,l.fullSeqDate=Rn,l.fullSeqDateISOString=Wn,l.groupBy=_,l.innerJoin=In,l.last=te,l.leftJoin=X,l.map=sn,l.matches=ce,l.max=Yn,l.mean=Zn,l.meanRate=Qn,l.median=Xn,l.min=Gn,l.mutate=w,l.mutateWithSummary=On,l.n=H,l.negate=le,l.numRange=se,l.pick=E,l.pivotLonger=Ln,l.pivotWider=zn,l.rate=Bn,l.rename=jn,l.replaceNully=on,l.roll=Pn,l.select=E,l.slice=W,l.sliceHead=kn,l.sliceMax=Kn,l.sliceMin=Mn,l.sliceSample=Fn,l.sliceTail=wn,l.sort=I,l.startsWith=ue,l.sum=P,l.summarize=D,l.summarizeAll=B,l.summarizeAt=J,l.summarizeIf=N,l.tally=G,l.tidy=z,l.total=an,l.totalAll=mn,l.totalAt=yn,l.totalIf=dn,l.transmute=An,l.variance=ne,l.vectorSeq=un,l.vectorSeqDate=C,l.when=cn,Object.defineProperty(l,"__esModule",{value:!0})});
//# sourceMappingURL=tidy.min.js.map
